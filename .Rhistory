sf::plot_sf(otter_poly[1])
ggplot(otter_poly, aes(fill=PolyID))+
geom_sf() +
theme_bw()
otter_poly[1]
View(otter_poly)
?sp::as
?as
# mutate(Area = sf::st_area(geometry))
as(otter_poly,'SpatialPolygonsDataFrame')
# mutate(Area = sf::st_area(geometry))
as(out_ras,'SpatialPolygonsDataFrame')
sf::as(out_ras,'SpatialPolygonsDataFrame')
methods::as(out_ras,'SpatialPolygonsDataFrame')
st_as_sf(out_ras)
sp::as.SpatialPolygons.PolygonsList(out_ras)
otter_poly <- methods::as(out_ras,'SpatialPolygonsDataFrame') %>%
st_as_sf()
otter_poly
sf::plot_sf(otter_poly[1])
otter_poly <- raster::rasterToPolygons(out_ras, fun=function(x){x>1e-12}, dissolve=TRUE) %>%
sf::st_as_sf() %>%
tibble::rownames_to_column(var = "PolyID")
otter_poly
otter_poly[1]
sf::plot_sf(otter_poly[1][1])
otter_poly[1][1]
otter_poly[1,]
sf::plot_sf(otter_poly[1,])
ggplot(otter_poly[1,], aes(fill=PolyID))+
geom_sf() +
theme_bw()
otter_poly <- raster::rasterToPolygons(out_ras, fun=function(x){x>1e-12}, dissolve=TRUE) %>%
sf::st_as_sf() %>%
sf::st_union()
otter_poly
ggplot(otter_poly, aes(fill=PolyID))+
geom_sf() +
theme_bw()
ggplot(otter_poly)+
geom_sf() +
theme_bw()
q25 <- quantile(out_ras, 0.25)
q25 <- quantile(out_ras, .25)
?quantile
q25 <- raster::quantile(out_ras, .25)
q25
rasmin <- min(out_ras)
rasmin <- raster::min(out_ras)
cellStats
raster::cellStats
rasmin <- raster::minValue(out_ras)
rasmin
?ecdf
ecdf(out_ras)
as.matrix(out_ras)
as.vector(out_ras)
?as.vector
rasvec <- raster::as.vector(out_ras) %>%
tidyr::drop_na()
rasvec <- raster::as.matrix(out_ras) %>%
tidyr::drop_na()
rasvec <- as.vector(out_ras) %>%
tidyr::drop_na()
rasvec <- as.vector(out_ras) %>%
rasvec <- rasvec[!is.na(rasvec)]
rasvec <- as.vector(out_ras)
rasvec <- rasvec[!is.na(rasvec)]
ecdf(rasvec)
f <- ecdf(rasvec)
f(0.5)
q50 <- raster::quantile(out_ras, .5)
q50
f(3.105889e-10)
b <- f(3.105889e-10)
plyr::round_any(b, 0.05, f = round)
plyr::round_any(0.26, 0.05, f = round)
otter_poly <- polygonise(out_ras, rasmin) %>%
dplyr::bind_rows(polygonise(out_ras, q75))
polygonise <- function(ras, thresh){
rasvec <- as.vector(ras)
rasvec <- rasvec[!is.na(rasvec)]
f <- ecdf(rasvec)
perc <- plyr::round_any(f(thresh), 0.05, f = round)
raster::rasterToPolygons(ras, fun=function(x){x>thresh}) %>%
sf::st_as_sf() %>%
sf::st_union() %>%
mutate(quant = perc)
}
otter_poly <- polygonise(out_ras, rasmin) %>%
dplyr::bind_rows(polygonise(out_ras, q75))
polygonise <- function(ras, thresh){
rasvec <- as.vector(ras)
rasvec <- rasvec[!is.na(rasvec)]
f <- ecdf(rasvec)
perc <- plyr::round_any(f(thresh), 0.05, f = round)
raster::rasterToPolygons(ras, fun=function(x){x>thresh}) %>%
sf::st_as_sf() %>%
sf::st_union() %>%
sf::st_as_sf() %>%
mutate(quant = perc)
}
otter_poly <- polygonise(out_ras, rasmin) %>%
dplyr::bind_rows(polygonise(out_ras, q75))
rasmin <- raster::minValue(out_ras)
q05 <- raster::quantile(out_ras, .05)
q25 <- raster::quantile(out_ras, .25)
q50 <- raster::quantile(out_ras, .5)
q75 <- raster::quantile(out_ras, .75)
q95 <- raster::quantile(out_ras, .95)
polygonise <- function(ras, thresh){
rasvec <- as.vector(ras)
rasvec <- rasvec[!is.na(rasvec)]
f <- ecdf(rasvec)
perc <- plyr::round_any(f(thresh), 0.05, f = round)
raster::rasterToPolygons(ras, fun=function(x){x>thresh}) %>%
sf::st_as_sf() %>%
sf::st_union() %>%
sf::st_as_sf() %>%
mutate(quant = perc)
}
otter_poly <- polygonise(out_ras, rasmin) %>%
dplyr::bind_rows(polygonise(out_ras, q75))
ggplot(otter_poly, fill=quant)+
geom_sf() +
theme_bw()
ggplot(otter_poly, aes(fill=quant))+
geom_sf() +
theme_bw()
ggplot(otter_poly, aes(fill=quant))+
geom_sf() +
scale_fill_viridis_b()+
theme_bw()
otter_poly <- polygonise(out_ras, rasmin) %>%
dplyr::bind_rows(polygonise(out_ras, q05)) %>%
dplyr::bind_rows(polygonise(out_ras, q25)) %>%
dplyr::bind_rows(polygonise(out_ras, q50)) %>%
dplyr::bind_rows(polygonise(out_ras, q75)) %>%
dplyr::bind_rows(polygonise(out_ras, q95))
ggplot(otter_poly, aes(fill=quant))+
geom_sf() +
scale_fill_viridis_b()+
theme_bw()
ggplot(otter_poly, aes(fill=quant))+
geom_sf(colour=NA) +
scale_fill_viridis_b()+
theme_bw()
p <- ggplot(otter_poly, aes(fill=quant))+
geom_sf(colour=NA) +
scale_fill_viridis_b()+
theme_bw()
library(rayshader)
plot_gg(p, width = 5, height = 5, multicore = TRUE, scale = 250,
zoom = 0.7, theta = 10, phi = 30, windowsize = c(800, 800))
p <- ggplot(otter_poly, aes(fill=quant))+
ggspatial::annotation_map_tile(type = 'osm', zoomin = 0, alpha = 0.8)
p <- ggplot(otter_poly, aes(fill=quant))+
ggspatial::annotation_map_tile(type = 'osm', zoomin = 0, alpha = 0.8) +
geom_sf(colour=NA) +
scale_fill_viridis_b()+
theme_bw()
library(rayshader)
plot_gg(p, width = 5, height = 5, multicore = TRUE, scale = 250,
zoom = 0.7, theta = 10, phi = 30, windowsize = c(800, 800))
p <- ggplot(otter_poly, aes(fill=quant))+
geom_sf(colour=NA) +
scale_fill_viridis_b()+
theme_bw()
?plot_gg
plot_gg(p, width = 5, height = 5, multicore = TRUE, scale = 150,
zoom = 0.7, theta = 10, phi = 30, windowsize = c(800, 800))
library(sf)
# library(sp)
# library(raster)
# library(ggspatial)
# library(gridExtra)
library(magrittr)
library(tidyverse)
devtools::load_all()
devtools::document()
ROBT_201920 <- RivOtter_FeedSigns %>%
dplyr::filter(SurveySeason == "2019 - 2020")
out_ras <- forage_density(ROBT_201920, 'FeedCat')
# out_ras <- forage_density(ROBT_201920, 'FeedCat', grid_size = 25, kern_bw = 100, kd_weights = c(1, 1e+03, 1e+06),
# low_thresh = 1e-12)
beaver_forage <- plot_forage_density(out_ras)
beaver_forage
rasmin <- raster::minValue(out_ras)
q05 <- raster::quantile(out_ras, .05)
q25 <- raster::quantile(out_ras, .25)
q50 <- raster::quantile(out_ras, .5)
q75 <- raster::quantile(out_ras, .75)
q95 <- raster::quantile(out_ras, .95)
polygonise <- function(ras, thresh){
rasvec <- as.vector(ras)
rasvec <- rasvec[!is.na(rasvec)]
f <- ecdf(rasvec)
perc <- plyr::round_any(f(thresh), 0.05, f = round)
raster::rasterToPolygons(ras, fun=function(x){x>thresh}) %>%
sf::st_as_sf() %>%
sf::st_union() %>%
sf::st_as_sf() %>%
mutate(quant = perc)
}
otter_poly <- polygonise(out_ras, rasmin) %>%
dplyr::bind_rows(polygonise(out_ras, q05)) %>%
dplyr::bind_rows(polygonise(out_ras, q25)) %>%
dplyr::bind_rows(polygonise(out_ras, q50)) %>%
dplyr::bind_rows(polygonise(out_ras, q75)) %>%
dplyr::bind_rows(polygonise(out_ras, q95))
p <- ggplot(otter_poly, aes(fill=quant))+
geom_sf(colour=NA) +
scale_fill_viridis_b()+
theme_bw()
p
?write_sf
sf::write_sf(otter_poly, dsn = 'run/otter_poly1819.gpkg')
unique(otter_poly$quant)
as.factor(0.5)
polygonise <- function(ras, thresh){
rasvec <- as.vector(ras)
rasvec <- rasvec[!is.na(rasvec)]
f <- ecdf(rasvec)
perc <- plyr::round_any(f(thresh), 0.05, f = round)
raster::rasterToPolygons(ras, fun=function(x){x>thresh}) %>%
sf::st_as_sf() %>%
sf::st_union() %>%
sf::st_as_sf() %>%
dplyr::mutate(quant = perc) %>%
dplyr::mutate(quantf = as.factor(quant))
}
otter_poly <- polygonise(out_ras, rasmin) %>%
dplyr::bind_rows(polygonise(out_ras, q05)) %>%
dplyr::bind_rows(polygonise(out_ras, q25)) %>%
dplyr::bind_rows(polygonise(out_ras, q50)) %>%
dplyr::bind_rows(polygonise(out_ras, q75)) %>%
dplyr::bind_rows(polygonise(out_ras, q95))
?scale_fill_brewer
p <- ggplot(otter_poly, aes(fill=quantf))+
geom_sf(colour=NA) +
scale_fill_brewer(palette = 'Dark2')+
theme_bw()
p
p <- ggplot(otter_poly, aes(fill=quant))+
geom_sf(colour=NA) +
scale_fill_brewer(palette = 'Dark2')+
theme_bw()
p
p <- ggplot(otter_poly, aes(fill=quantf))+
geom_sf(colour=NA) +
scale_fill_brewer(palette = 'Dark2')+
theme_bw()
p
p <- ggplot(otter_poly, aes(fill=quantf))+
geom_sf(colour=NA) +
scale_fill_brewer(palette = 'Dark2' direction = -1)+
theme_bw()
p <- ggplot(otter_poly, aes(fill=quantf))+
geom_sf(colour=NA) +
scale_fill_brewer(palette = 'Dark2', direction = -1)+
theme_bw()
p
otter_poly <- polygonise(out_ras, rasmin) %>%
# dplyr::bind_rows(polygonise(out_ras, q05)) %>%
dplyr::bind_rows(polygonise(out_ras, q25)) %>%
dplyr::bind_rows(polygonise(out_ras, q50)) %>%
dplyr::bind_rows(polygonise(out_ras, q75)) %>%
dplyr::bind_rows(polygonise(out_ras, q95))
p <- ggplot(otter_poly, aes(fill=quantf))+
geom_sf(colour=NA) +
scale_fill_brewer(palette = 'Dark2', direction = -1)+
theme_bw()
p
otter_poly_simp <- rmapshaper::ms_simplify(otter_poly)
p <- ggplot(otter_poly_simp, aes(fill=quantf))+
geom_sf(colour=NA) +
scale_fill_brewer(palette = 'Dark2', direction = -1)+
theme_bw()
p
?rmapshaper::ms_simplify
otter_poly_simp <- rmapshaper::ms_simplify(otter_poly, keep=0.75, method='vis', weighting=0.8, keep_shapes=TRUE, explode = TRUE)
p <- ggplot(otter_poly_simp, aes(fill=quantf))+
geom_sf(colour=NA) +
scale_fill_brewer(palette = 'Dark2', direction = -1)+
theme_bw()
p
sf::write_sf(otter_poly, dsn = 'run/otter_poly1819b.gpkg')
sf::write_sf(otter_poly_simp, dsn = 'run/otter_poly1819b.gpkg')
otter_poly_simp <- rmapshaper::ms_simplify(otter_poly, keep=0.5, method='vis', weighting=0.7, keep_shapes=TRUE, explode = TRUE)
sf::write_sf(otter_poly_simp, dsn = 'run/otter_poly1819c.gpkg')
otter_poly
otter_polyb <- sf::st_cast(otter_poly, to='POLYGON')
p <- ggplot(otter_polyb, aes(fill=quantf))+
geom_sf(colour=NA) +
scale_fill_brewer(palette = 'Dark2', direction = -1)+
theme_bw()
p
otter_polyb
rownames(otter_polyb)<-NULL
otter_polyb
polygonise <- function(ras, thresh){
rasvec <- as.vector(ras)
rasvec <- rasvec[!is.na(rasvec)]
f <- ecdf(rasvec)
perc <- plyr::round_any(f(thresh), 0.05, f = round)
raster::rasterToPolygons(ras, fun=function(x){x>thresh}) %>%
sf::st_as_sf() %>%
sf::st_union() %>%
sf::st_as_sf() %>%
dplyr::mutate(quant = perc) %>%
dplyr::mutate(quantf = as.factor(quant))
}
kde_to_polgyon <- function(forage_raster){
rasmin <- raster::minValue(forage_raster)
# q05 <- raster::quantile(forage_raster, .05)
q25 <- raster::quantile(forage_raster, .25)
q50 <- raster::quantile(forage_raster, .5)
q75 <- raster::quantile(forage_raster, .75)
q95 <- raster::quantile(forage_raster, .95)
forage_poly <- polygonise(forage_raster, rasmin) %>%
# dplyr::bind_rows(polygonise(forage_raster, q05)) %>%
dplyr::bind_rows(polygonise(forage_raster, q25)) %>%
dplyr::bind_rows(polygonise(forage_raster, q50)) %>%
dplyr::bind_rows(polygonise(forage_raster, q75)) %>%
dplyr::bind_rows(polygonise(forage_raster, q95)) %>%
sf::st_cast(otter_poly, to='POLYGON')
rownames(forage_poly)<-NULL
return(forage_poly)
}
kde_to_polgyon(out_ras)
list('a') + list('b')
c( list('a'), list('b'))
rasmin <- raster::minValue(forage_raster)
raster::minValue(out_ras_
)
raster::minValue(out_ras)
raster::quantile(out_ras, 0)
quant_list <- list(0, .25, .5, .75, .95) %>%
purrr::map(., ~ raster::quantile(out_ras, .))
quant_list
quant_list %>%
purrr::map(., ~ polygonise(out_ras, .)) %>%
dplyr::bind_rows()%>%
sf::st_cast(., to='POLYGON')
?supressWarnings
kde_to_polgyon <- function(forage_raster){
quant_list <- list(0, .25, .5, .75, .95) %>%
purrr::map(., ~ raster::quantile(out_ras, .))
forage_poly <- quant_list %>%
purrr::map(., ~ polygonise(out_ras, .)) %>%
dplyr::bind_rows()%>%
sf::st_cast(., to='POLYGON')
forage_poly <- polygonise(forage_raster, rasmin) %>%
# dplyr::bind_rows(polygonise(forage_raster, q05)) %>%
dplyr::bind_rows(polygonise(forage_raster, q25)) %>%
dplyr::bind_rows(polygonise(forage_raster, q50)) %>%
dplyr::bind_rows(polygonise(forage_raster, q75)) %>%
dplyr::bind_rows(polygonise(forage_raster, q95)) %>%
suppressWarnings(sf::st_cast(otter_poly, to='POLYGON'))
rownames(forage_poly)<-NULL
return(forage_poly)
}
kde_to_polgyon(out_ras)
otter_poly <- kde_to_polgyon(out_ras)
p <- ggplot(otter_poly, aes(fill=quantf))+
geom_sf(colour=NA) +
scale_fill_brewer(palette = 'Set1', direction = -1)+
theme_bw()
p
sf::write_sf(otter_poly, dsn = 'run/otter_poly1819b.gpkg')
kde_to_polgyon <- function(forage_raster, low_thresh = 0, upper_thresh = 0.95){
quant_list <- list(low_thresh, upper_thresh) %>%
purrr::map(., ~ raster::quantile(out_ras, .))
forage_poly <- quant_list %>%
purrr::map(., ~ polygonise(out_ras, .)) %>%
dplyr::bind_rows()%>%
sf::st_cast(., to='POLYGON')
#
#   forage_poly <- polygonise(forage_raster, rasmin) %>%
#     # dplyr::bind_rows(polygonise(forage_raster, q05)) %>%
#     dplyr::bind_rows(polygonise(forage_raster, q25)) %>%
#     dplyr::bind_rows(polygonise(forage_raster, q50)) %>%
#     dplyr::bind_rows(polygonise(forage_raster, q75)) %>%
#     dplyr::bind_rows(polygonise(forage_raster, q95)) %>%
#     sf::st_cast(otter_poly, to='POLYGON')
rownames(forage_poly)<-NULL
return(forage_poly)
}
otter_poly <- kde_to_polgyon(out_ras)
p <- ggplot(otter_poly, aes(fill=quantf))+
geom_sf(colour=NA) +
scale_fill_brewer(palette = 'Set1', direction = -1)+
theme_bw()
p
?sclae_fill_manual
?scale_fill_manual
p <- ggplot(otter_poly, aes(fill=quantf))+
geom_sf(colour=NA) +
scale_fill_manual(values = c("#F87223", "#23AAF8"))
p
p <- ggplot(otter_poly, aes(fill=quantf))+
geom_sf(colour='#818486') +
scale_fill_manual(values = c("#F87223", "#23AAF8"))+
theme_bw()
p
p <- ggplot(otter_poly, aes(fill=quantf))+
geom_sf(colour='#818486', alpha=0.7) +
scale_fill_manual(values = c("#23AAF8", "#F87223"))+
theme_bw()
p
kde_to_polgyon <- function(forage_raster, low_thresh = 0, upper_thresh = 0.95){
quant_list <- list(low_thresh, upper_thresh) %>%
purrr::map(., ~ raster::quantile(out_ras, .))
poly_list <- quant_list %>%
purrr::map(., ~ polygonise(out_ras, .)) %>%
purrr::map(., ~ sf::st_cast(., to='POLYGON'))
forage_poly <- sf::st_intersects(poly_list[[1]], poly_list[[2]])
rownames(forage_poly)<-NULL
return(forage_poly)
}
otter_poly <- kde_to_polgyon(out_ras)
otter_poly
?st_intersects
?st_intersection
kde_to_polgyon <- function(forage_raster, low_thresh = 0, upper_thresh = 0.95){
quant_list <- list(low_thresh, upper_thresh) %>%
purrr::map(., ~ raster::quantile(out_ras, .))
poly_list <- quant_list %>%
purrr::map(., ~ polygonise(out_ras, .)) %>%
purrr::map(., ~ sf::st_cast(., to='POLYGON'))
forage_poly <- sf::st_intersection(poly_list[[1]], poly_list[[2]])
rownames(forage_poly)<-NULL
return(forage_poly)
}
otter_poly <- kde_to_polgyon(out_ras)
otter_poly
p <- ggplot(otter_poly, aes(fill=quantf))+
geom_sf(colour='#818486', alpha=0.7) +
scale_fill_manual(values = c("#23AAF8", "#F87223"))+
theme_bw()
p
?row_number()
kde_to_polgyon <- function(forage_raster, low_thresh = 0, upper_thresh = 0.95){
quant_list <- list(low_thresh, upper_thresh) %>%
purrr::map(., ~ raster::quantile(out_ras, .))
poly_list <- quant_list %>%
purrr::map(., ~ polygonise(out_ras, .)) %>%
purrr::map(., ~ sf::st_cast(., to='POLYGON'))
# forage_poly <- sf::st_intersection(poly_list[[1]], poly_list[[2]])
forage_poly <- poly_list[[1]] %>%
dplyr::mutate(id = dplyr::row_number() ) %>%
#filter out states that do not have any intersetcions with the points/cities
dplyr::filter( id %in% unlist( st_intersects(poly_list[[2]], poly_list[[1]]) ) )
rownames(forage_poly)<-NULL
return(forage_poly)
}
otter_poly <- kde_to_polgyon(out_ras)
otter_poly
p <- ggplot(otter_poly, aes(fill=quantf))+
geom_sf(colour='#818486', alpha=0.7) +
scale_fill_manual(values = c("#23AAF8", "#F87223"))+
theme_bw()
p
p <- ggplot(otter_poly, aes(fill=id))+
geom_sf(colour='#818486', alpha=0.7)
p
p <- ggplot(otter_poly, aes(fill=as.factor(id)))+
geom_sf(colour='#818486', alpha=0.7)
p
polygonise <- function(ras, thresh){
rasvec <- as.vector(ras)
rasvec <- rasvec[!is.na(rasvec)]
f <- ecdf(rasvec)
perc <- plyr::round_any(f(thresh), 0.05, f = round)
raster::rasterToPolygons(ras, fun=function(x){x>thresh}) %>%
sf::st_as_sf() %>%
sf::st_union() %>%
sf::st_as_sf() %>%
dplyr::mutate(quant = perc) %>%
dplyr::mutate(quantf = as.factor(quant)) %>%
sf::st_cast(., to='POLYGON')
}
kde_to_polgyon <- function(forage_raster, low_thresh = 0, upper_thresh = 0.95){
quant_list <- list(low_thresh, upper_thresh) %>%
purrr::map(., ~ raster::quantile(out_ras, .))
poly_list <- quant_list %>%
purrr::map(., ~ polygonise(out_ras, .))
Yes_upper <- poly_list[[1]] %>%
dplyr::mutate(id = dplyr::row_number() ) %>%
dplyr::filter( id %in% unlist(st_intersects(poly_list[[2]], poly_list[[1]]))) %>%
dplyr::mutate(Upper_Thresh = 'Yes')
No_upper <- poly_list[[1]] %>%
dplyr::mutate(id = dplyr::row_number() ) %>%
dplyr::filter( id %in% unlist(!st_intersects(poly_list[[2]], poly_list[[1]])))%>%
dplyr::mutate(Upper_Thresh = 'No')
forage_poly <- dplyr::bind_rows(Yes_upper, No_upper)
rownames(forage_poly)<-NULL
return(forage_poly)
}
otter_poly <- kde_to_polgyon(out_ras)
otter_poly
p <- ggplot(otter_poly, aes(fill=Upper_Thresh))+
geom_sf(colour='#818486', alpha=0.7) +
scale_fill_manual(values = c("#23AAF8", "#F87223"))+
theme_bw()
p
otter_poly <- kde_to_polgyon(out_ras, low_thresh = 0.2, upper_thresh = 0.8)
p <- ggplot(otter_poly, aes(fill=Upper_Thresh))+
geom_sf(colour='#818486', alpha=0.7) +
scale_fill_manual(values = c("#23AAF8", "#F87223"))+
theme_bw()
p
